<script>
  var imageList = Array();
</script>

<div class="row mb-3">
  <div class="col-md-16">
    <h1>
      Add placements to <%= @episode.title %>
    </h1>
    
    <hr>
    
    <div class="row mb-3">
      <div class="col">
      <form action="/create_placement/<%= @episode.id %>" method="post">
        <label for="ad"><b>Select Ad</b></label>
          <select id="adSelect" name="ad_id" onChange="setImage()">
            <option selected></option>
            <script>
              imageList.push('');
            </script>
            <% Ad.all.order(:name => :asc).each do |thisad| %>
              <option value=<%= thisad.id %>><%= thisad.name %></option>
              <script>
                imageList.push('<%= thisad.image_url(:standard) %>');
              </script>
            <% end %>
          </select>
        <label for="start">Start Time</label>
          <input type="text" id="start" name="start" placeholder="Use buttons at right to set..." readonly>
        <label for="end">End Time</label>
          <input type="text" id="end" name="end" placeholder="Use buttons at right to set..." readonly>
        <label for="posx">X-position</label>
          <input type="text" id="posx" name="posx" placeholder="Left edge position..." readonly value="0">
        <label for="posy">Y-position</label>
          <input type="text" id="posy" name="posy" placeholder="Top edge position..." readonly value="0">
          <input type="text" id="currentTime" name="currentTime">
          <input type="hidden" id="width" name="width">
          <input type="hidden" id="height" name="height">
        <button>Place ad</button>
      </form>
      
      </div>
<!-- DRAG AND DROP CANVAS BEGIN -->
      
      <div class="col">
          <div id="container">
            <div class="konvajs-content" role="presentation" style="position: relative; user-select: none; width: 500px; height: 500px;">
              <canvas width="500" height="500" style="padding: 0px; margin: 0px; border: 0px; background: transparent; position: absolute; 
                                                      top: 0px; left: 0px; width: 500px; height: 500px; display: block;">
              </canvas>
            </div>
        </div>

  <!-- set logo url variable for js -->
        <script>
          var imgurl = '<%= Podcast.find(@episode.podcast_id).logo_url(:standard) %>';
          var adurl = '<%= Ad.all.order( :name => :asc ).first.image_url(:standard) %>';
        </script>

        <%= javascript_include_tag "fullcanvas" %>

        <audio id="player" controls>
          <source src="<%= @episode.audio_url %>" type="audio/mp3">
        </audio>
        <script>
          
        </script>
        <%= javascript_include_tag "audiofunctions" %>
        <div class="row mb-3">
          <div class="col">
            <input type="button" value="Set start time" onclick="populateStartTime()">
          </div>
          <div class="col">
            <input type="button" value="Set end time" onclick="populateEndTime()">
          </div>
        </div>
      </div>
      
<!-- DRAG AND DROP CANVAS END -->
    </div>
    
    <div class="row mb-3">
      <div class="col">
      <table>
      <tr>
        <th>Ad</th>
        <th></th>
        <th>Start Time</th>
        <th>End Time</th>
        <th></th>
      </tr>
      <% p = 0 %>
      <% @episode.placements.each do |placement| %>
        <tr>
          <td><%= Ad.find(placement.ad_id).name %></td>
          <td><%= image_tag(Ad.find(placement.ad_id).image_url(:thumbnail)) %></td>
          <td><%= placement.timestamp_start %></td>
          <td><%= placement.timestamp_end %></td>
          <td><a href="/delete_placement/<%= placement.id %>">Delete placement</a></td>
          <script>
            var a = <%= placement.timestamp_start %>;
            var b = <%= placement.timestamp_end %>;
            reBuild(<%= p %>, <%= placement.position_x %>, <%= placement.position_y %>, <%= placement.width %>, <%= placement.height %>, "<%= Ad.find(placement.ad_id).image_url(:standard) %>");

            player.on('timeupdate', function(event) {
              var c = player.currentTime;
              document.getElementById('currentTime').value = c;
              if (c > a && c < b) {
                adShower(<%= p %>);
              } else if (c > b) {
                adHider(<%= p %>);
              }
            });
          </script>
        </tr>
      <% p += 1 %>
      <% end %>
      
    </table>
      </div>
    </div>

    
  </div>
</div>
<hr>

<a href="/placements">
  Go back
</a>
